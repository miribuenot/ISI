---- MODULE despertador ----
EXTENDS Naturals

RANGE_HOURS == 1..12
RANGE_MINS == 0..59
RANGE_IND == {"AM", "PM"}

(* --algorithm despertador {

variables
    hr \in RANGE_HOURS,
    min \in RANGE_MINS,
    ind \in RANGE_IND,
    \* Usamos un Record para la alarma. Inicialmente valores nulos o imposibles.
    \* O mejor, usamos una variable booleana para saber si está puesta.
    al_h = 0, al_m = 0, al_i = "AM",
    is_alarm_set = FALSE, 
    sound = "OFF",
    timer = 0; \* Contador para los 5 minutos

fair process (Clock = "Clock")
{Clock:  
    while (TRUE) {
    Tick:
        \* 1. AVANCE DEL TIEMPO (Igual que antes)
        if (min < 59) {
            min := min + 1;
        }
        else {
            min := 0;
            if (hr = 11) {
                hr := 12;
                ind := IF ind = "AM" THEN "PM" ELSE "AM";
            }
            else if (hr = 12) {
                hr := 1;
            }
            else {
                hr := hr + 1;
            }
        };

        \* 2. LÓGICA DE ALARMA UNIFICADA
        \* Usamos ELSE para evitar modificar 'timer' dos veces en el mismo paso.
        
        if (is_alarm_set /\ sound = "OFF" /\ hr = al_h /\ min = al_m /\ ind = al_i) {
            \* CASO A: La alarma se dispara AHORA MISMO
            sound := "ON";
            timer := 0; 
        }
        else if (sound = "ON") {
            \* CASO B: La alarma YA estaba sonando, contamos el tiempo
            timer := timer + 1;
            if (timer >= 5) {
                sound := "OFF";
            }
        };
        \* CASO C: Ni salta la alarma ni está sonando -> No hacemos nada con timer/sound
    }
}

\* BOTÓN DE APAGAR SONIDO (Requisito 3)
fair process (StopSoundButton = "StopSound")
{StopSound:
    while(TRUE) {
        await (sound = "ON"); \* Solo tiene efecto si está sonando
        sound := "OFF";
        \* La alarma sigue programada (is_alarm_set sigue TRUE), sonará en 12/24h
    }
}

\* BOTÓN DE DESPROGRAMAR ALARMA (Requisito 5)
fair process (UnsetAlarmButton = "UnsetAlarm")
{UnsetAlarm:
    while(TRUE) {
        await (is_alarm_set = TRUE); \* Solo si hay alarma puesta
        is_alarm_set := FALSE;
        sound := "OFF"; \* Si estaba sonando, también se calla al quitar la alarma
    }
}

}
*)

====